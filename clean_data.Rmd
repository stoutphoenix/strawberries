---
title: "filter_transport_data"
output: pdf_document
date: "2025-10-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Filter quarterly volume transport data

Source: <https://www.ams.usda.gov/services/transportation-analysis/agricultural-refrigerated-truck-quarterly-datasets>

quarterly_vols_all: "Quarterly Shipment Volumes by Origin and Commodity" Quarterly totals of refrigerated truck load volumes (tonnage) from U.S. origin shipping areas and cross-border movements from Mexico and Canada for individual fruit and vegetable varieties. Entries marked zero tons were registered commodity movements, but the sum of all shipment volumes totaled less than 1. Source: Specialty Crops/Market News/AMS/USDA

### Filter to only strawberries

```{r}
library(dplyr)
df <- read.csv("quarterly_vols_all.csv")

strawberry_data <- df %>%
  filter(grepl("st[r]?awberr(y|ies)", Commodity, ignore.case = TRUE))

write.csv(strawberry_data, "quarterly_vols_strawberries.csv", row.names = FALSE)
```

## Clean USDA Strawberry Data

**Source:** <https://quickstats.nass.usda.gov/#C1D8E381-62E7-385D-8B69-015732CD24A0>

**Selection Criteria:** - **Program:** Survey - Provides more frequent and current statistics than Census data - Better for tracking seasonal patterns and market trends - **Sector:** Crops - **Group:** Fruit & Tree Nuts - **Commodity:** Strawberries - **Categories Selected:** - **Production:** Strawberry volumes produced; enables direct comparison with shipment volumes - **Price Received:** Market value; helps explain economic factors affecting transportation decisions

-   **Data Items:**
    -   **STRAWBERRIES - PRICE RECEIVED, MEASURED IN \$ / CWT**
        -   Overall average farm-gate price across all strawberry uses
    -   **STRAWBERRIES, FRESH MARKET - PRICE RECEIVED, MEASURED IN \$ / CWT**
        -   Price specifically for fresh market strawberries; most relevant for refrigerated shipment analysis since fresh berries command higher prices and require immediate refrigerated transport
    -   **STRAWBERRIES, PROCESSING - PRICE RECEIVED, MEASURED IN \$ / CWT**
        -   Price for processing strawberries; typically lower than fresh market prices as these berries are destined for freezing, jam production, etc.
    -   **STRAWBERRIES - PRODUCTION, MEASURED IN \$**
        -   Total production value across all uses; useful for calculating total volume when combined with price data
    -   **STRAWBERRIES - PRODUCTION, MEASURED IN CWT**
        -   Total production volume in hundredweight (CWT = 100 lbs); includes both fresh market and processing
    -   **STRAWBERRIES, FRESH MARKET - PRODUCTION, MEASURED IN \$**
        -   Dollar value of fresh market production specifically; most relevant for comparison with refrigerated shipment data
    -   **STRAWBERRIES, FRESH MARKET - PRODUCTION, MEASURED IN CWT**
        -   Fresh market production volume; PRIMARY metric for direct comparison with refrigerated truck shipment data, as fresh berries are perishable and require refrigerated transport
    -   **STRAWBERRIES, PROCESSING - PRODUCTION, MEASURED IN \$**
        -   Dollar value of processing strawberries; less relevant for refrigerated shipment analysis
    -   **STRAWBERRIES, PROCESSING - PRODUCTION, MEASURED IN CWT**
        -   Volume of strawberries destined for processing; not directly comparable to refrigerated shipments as these may be frozen on-site or follow different logistics
    -   **STRAWBERRIES, UTILIZED - PRODUCTION, MEASURED IN CWT**
        -   Total utilized production (fresh market + processing); represents all strawberries that entered commercial channels

**Note on Data Strategy:** - Fresh market production metrics are the primary focus for refrigerated shipment analysis - Price data enables inference of missing production volumes using the formula: Production (CWT) = Production ($) / Price ($/CWT) - Separate fresh market and processing categories allow for more accurate analysis of transportation patterns, as only fresh market strawberries typically move via refrigerated trucks immediately after harvest

```{r}
library(janitor)
library(dplyr)
library(readr)
library(tidyr)

relevant_strawberries <- read_csv("relevant_strawberries.csv")
relevant_strawberries <- clean_names(relevant_strawberries)

# Remove columns with all NAs
relevant_strawberries <- relevant_strawberries %>%
  select(where(~!all(is.na(.))))

# Remove columns with no variation
relevant_strawberries <- relevant_strawberries %>%
  select(-c(geo_level, watershed_code, commodity, domain, domain_category))

# Pivot the data to wide format
relevant_strawberries_wide <- relevant_strawberries %>%
  mutate(metric = case_when(
    # Price metrics
    data_item == "STRAWBERRIES - PRICE RECEIVED, MEASURED IN $ / CWT" ~ "price_overall",
    data_item == "STRAWBERRIES, FRESH MARKET - PRICE RECEIVED, MEASURED IN $ / CWT" ~ "price_fresh",
    data_item == "STRAWBERRIES, PROCESSING - PRICE RECEIVED, MEASURED IN $ / CWT" ~ "price_processing",
    
    # Production in dollars
    data_item == "STRAWBERRIES - PRODUCTION, MEASURED IN $" ~ "production_dollars_total",
    data_item == "STRAWBERRIES, FRESH MARKET - PRODUCTION, MEASURED IN $" ~ "production_dollars_fresh",
    data_item == "STRAWBERRIES, PROCESSING - PRODUCTION, MEASURED IN $" ~ "production_dollars_processing",
    
    # Production in CWT
    data_item == "STRAWBERRIES - PRODUCTION, MEASURED IN CWT" ~ "production_cwt_total",
    data_item == "STRAWBERRIES, FRESH MARKET - PRODUCTION, MEASURED IN CWT" ~ "production_cwt_fresh",
    data_item == "STRAWBERRIES, PROCESSING - PRODUCTION, MEASURED IN CWT" ~ "production_cwt_processing",
    data_item == "STRAWBERRIES, UTILIZED - PRODUCTION, MEASURED IN CWT" ~ "production_cwt_utilized",
    
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(metric)) %>%
  pivot_wider(
    id_cols = c(year, state, state_ansi),
    names_from = metric,
    values_from = value,
    values_fn = list(value = ~first(na.omit(.)))  # Takes first non-NA value
  ) %>%
  arrange(year, state)

# Convert all numeric columns
relevant_strawberries_wide <- relevant_strawberries_wide %>%
  mutate(across(c(price_overall, price_fresh, price_processing,
                  production_dollars_total, production_dollars_fresh, production_dollars_processing,
                  production_cwt_total, production_cwt_fresh, production_cwt_processing, 
                  production_cwt_utilized),
                ~as.numeric(gsub(",", "", .))))

# Calculate inferred production volumes where direct measurements are missing
relevant_strawberries_wide <- relevant_strawberries_wide %>%
  mutate(
    # Infer fresh market CWT from dollars and price when direct measurement is missing
    production_cwt_fresh_inferred = production_dollars_fresh / price_fresh,
    
    # Infer processing CWT from dollars and price when direct measurement is missing
    production_cwt_processing_inferred = production_dollars_processing / price_processing,
    
    # Infer total CWT from dollars and overall price when direct measurement is missing
    production_cwt_total_inferred = production_dollars_total / price_overall
  )


# Save the result
write.csv(relevant_strawberries_wide, "relevant_strawberries_wide.csv", row.names = FALSE)

```


## Combine shipment and production data

```{r}
production_data <- read_csv("relevant_strawberries_wide.csv")
shipment_data <- read_csv("quarterly_vols_strawberries.csv")


# 1. Process the Shipment (transport) data
# The goal is to aggregate quarterly shipment data into annual totals
# to match the annual production data.
annual_shipments <- shipment_data %>%
  # Group data by the Year and the Origin (state)
  group_by(Year, Origin) %>%  
  # Sum the 'Tons' for each group to get a yearly total per state
  summarise(
    total_tonnage = sum(Tons, na.rm = TRUE) # na.rm = TRUE ignores missing values
  ) %>%
  ungroup() %>% 
  # Rename columns to match the 'production_data' for joining
  # 'Year' -> 'year'
  # 'Origin' -> 'state'
  rename(year = Year, state = Origin) 

# Now, 'annual_shipments' has 'year', 'state', and 'total_tonnage' columns.

# 2. Process the Production data (Unify units)
# The production data ('production_cwt') is in "hundredweight" (CWT).
# The shipment data ('total_tonnage') is in "Tons".
# We must convert them to the same unit for a valid comparison.
# Conversion: 1 Ton = 2000 lbs, 1 CWT = 100 lbs. Therefore, 1 Ton = 20 CWT.
production_data <- production_data %>%
  mutate(
    # Create a new column 'production_tons' by dividing CWT by 20
    production_tons_total = production_cwt_total / 20 
  )


# 3. Join the two datasets
# Use inner_join to combine the two tables.
# It will only keep rows where the 'year' AND 'state' exist in BOTH tables.
combined_data <- inner_join(
  annual_shipments,    # Left table (annual shipments)
  production_data,     # Right table (annual production)
  by = c("year", "state") # The common columns to match on
)
write.csv(combined_data, "combined_data.csv", row.names = FALSE)
```

```{r}
combined_data
```

```{r}
# This keeps ALL states from production_data (the "left" table)
# and adds shipment data (from annual_shipments) only where it matches.
all_states_combined_data <- left_join(
  production_data,     # Left table (annual production for ALL states)
  annual_shipments,    # Right table (annual shipments)
  by = c("year", "state") # Common key columns
)

# Group states into three categories: CALIFORNIA, FLORIDA, and "Other States"
grouped_data <- all_states_combined_data %>%
  mutate(
    state_group = case_when(
      state == "CALIFORNIA" ~ "CALIFORNIA",
      state == "FLORIDA"    ~ "FLORIDA",
      TRUE                  ~ "Other States" # All other states go here
    )
  )

# Now we sum production/shipments for all "Other States" for each year
annual_comparison_data <- grouped_data %>%
  group_by(year, state_group) %>%
  summarise(
    # We must use na.rm = TRUE here
    total_production = sum(production_tons, na.rm = TRUE),
    total_shipment = sum(total_tonnage, na.rm = TRUE)
  ) %>%
  ungroup()

# Visualize Production (CA vs. FL vs. "Other")
# produtction_ct for year>2016 not added yet
plot_production_grouped <- ggplot(annual_comparison_data, 
                                  aes(x = year, y = total_production, color = state_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("CALIFORNIA" = "blue", "FLORIDA" = "green", "Other States" = "red"),
                     breaks = c("CALIFORNIA", "FLORIDA", "Other States")) +
  labs(
    title = "Annual Strawberry Production: CA & FL vs. All Other States",
    x = "Year",
    y = "Total Production (Tons)",
    color = "State Group"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma)

print(plot_production_grouped)

# Visualize Shipments (CA vs. FL vs. "Other")
# Note: "Other States" shipments will be very low, as most don't have shipment data
plot_shipment_grouped <- ggplot(annual_comparison_data, 
                                aes(x = year, y = total_shipment, color = state_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("CALIFORNIA" = "blue", "FLORIDA" = "green", "Other States" = "red"),
                     breaks = c("CALIFORNIA", "FLORIDA", "Other States")) +
  labs(
    title = "Annual Strawberry Shipments: CA & FL vs. All Other States",
    x = "Year",
    y = "Total Shipments (Tons)",
    color = "State Group"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma)

print(plot_shipment_grouped)
```